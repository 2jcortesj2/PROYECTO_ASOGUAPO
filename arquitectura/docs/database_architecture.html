<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Documentaci&oacute;n T&eacute;cnica - Gesti&oacute;n de Base de Datos SQLite</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="documentación-técnica---gestión-de-base-de-datos-sqlite">Documentación Técnica - Gestión de Base de Datos SQLite</h1>
<h2 id="arquitectura-de-datos">Arquitectura de Datos</h2>
<h3 id="modelo-entidad-relación">Modelo Entidad-Relación</h3>
<pre><code>┌─────────────────────────────┐
│       CONTADORES            │
├─────────────────────────────┤
│ PK  id (TEXT)               │
│     nombre (TEXT)           │
│     vereda (TEXT)           │
│     lote (TEXT)             │
│     ultima_lectura (REAL)   │
│     fecha_ultima_lectura    │
│     estado (TEXT)           │
└─────────────────────────────┘
           │
           │ 1:N
           ▼
┌─────────────────────────────┐
│        LECTURAS             │
├─────────────────────────────┤
│ PK  id (INTEGER)            │
│ FK  contador_id (TEXT)      │
│     nombre_usuario (TEXT)   │
│     vereda (TEXT)           │
│     lectura (REAL)          │
│     foto_path (TEXT)        │
│     latitud (REAL)          │
│     longitud (REAL)         │
│     fecha (TEXT)            │
│     sincronizado (INTEGER)  │
└─────────────────────────────┘
</code></pre>
<h2 id="esquema-de-base-de-datos">Esquema de Base de Datos</h2>
<h3 id="tabla-contadores">Tabla: <code>contadores</code></h3>
<p>Almacena el padrón de usuarios/medidores del sistema.</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> contadores (
  id TEXT <span class="hljs-keyword">PRIMARY</span> KEY,              <span class="hljs-comment">-- Código concatenado (ej: &quot;PUE-102-9&quot;)</span>
  nombre TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,             <span class="hljs-comment">-- Nombre completo del usuario</span>
  vereda TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,             <span class="hljs-comment">-- Vereda/Sector (El Recreo, Pueblo Nuevo, El Tendido)</span>
  lote TEXT,                        <span class="hljs-comment">-- Lote/Predio (opcional)</span>
  ultima_lectura <span class="hljs-type">REAL</span>,              <span class="hljs-comment">-- Última lectura registrada (referencia histórica)</span>
  fecha_ultima_lectura TEXT,        <span class="hljs-comment">-- Fecha de la última lectura (ISO 8601)</span>
  estado TEXT                       <span class="hljs-comment">-- Estado: &#x27;pendiente&#x27;, &#x27;registrado&#x27;, &#x27;conError&#x27;</span>
);
</code></pre>
<p><strong>Índices:</strong></p>
<ul>
<li>PRIMARY KEY en <code>id</code></li>
</ul>
<p><strong>Estados posibles:</strong></p>
<ul>
<li><code>pendiente</code>: Sin lectura para el periodo actual</li>
<li><code>registrado</code>: Con lectura registrada para hoy</li>
<li><code>conError</code>: Lectura con problemas de validación</li>
</ul>
<hr>
<h3 id="tabla-lecturas">Tabla: <code>lecturas</code></h3>
<p>Almacena el historial de lecturas tomadas con la aplicación.</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> lecturas (
  id <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTOINCREMENT,  <span class="hljs-comment">-- ID autoincremental</span>
  contador_id TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,             <span class="hljs-comment">-- FK a contadores.id</span>
  nombre_usuario TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,          <span class="hljs-comment">-- Nombre del usuario (desnormalizado para reportes)</span>
  vereda TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,                  <span class="hljs-comment">-- Vereda (desnormalizado para reportes)</span>
  lectura <span class="hljs-type">REAL</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,                 <span class="hljs-comment">-- Valor de la lectura en m³</span>
  foto_path TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,               <span class="hljs-comment">-- Ruta local de la foto del medidor</span>
  latitud <span class="hljs-type">REAL</span>,                          <span class="hljs-comment">-- Coordenada GPS (opcional)</span>
  longitud <span class="hljs-type">REAL</span>,                         <span class="hljs-comment">-- Coordenada GPS (opcional)</span>
  fecha TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,                   <span class="hljs-comment">-- Fecha/hora de captura (ISO 8601)</span>
  sincronizado <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,        <span class="hljs-comment">-- 0 = no sincronizado, 1 = sincronizado</span>
  <span class="hljs-keyword">FOREIGN</span> KEY (contador_id) <span class="hljs-keyword">REFERENCES</span> contadores(id)
);

<span class="hljs-comment">-- Índices para optimización</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_lecturas_fecha <span class="hljs-keyword">ON</span> lecturas(fecha);
<span class="hljs-keyword">CREATE</span> INDEX idx_lecturas_contador <span class="hljs-keyword">ON</span> lecturas(contador_id);
</code></pre>
<p><strong>Índices:</strong></p>
<ul>
<li>PRIMARY KEY en <code>id</code></li>
<li>INDEX en <code>fecha</code> (para consultas por periodo)</li>
<li>INDEX en <code>contador_id</code> (para consultas por usuario)</li>
<li>FOREIGN KEY a <code>contadores(id)</code></li>
</ul>
<hr>
<h2 id="operaciones-crud">Operaciones CRUD</h2>
<h3 id="databaseservice---métodos-principales">DatabaseService - Métodos Principales</h3>
<h4 id="contadores">Contadores</h4>
<pre><code class="language-dart"><span class="hljs-comment">// Insertar o actualizar contador</span>
Future&lt;<span class="hljs-built_in">int</span>&gt; insertContador(Contador contador)
  → INSERT con ConflictAlgorithm.replace

<span class="hljs-comment">// Obtener todos los contadores</span>
Future&lt;<span class="hljs-built_in">List</span>&lt;Contador&gt;&gt; getContadores()
  → SELECT * FROM contadores

<span class="hljs-comment">// Obtener contador por ID</span>
Future&lt;Contador?&gt; getContadorById(<span class="hljs-built_in">String</span> id)
  → SELECT * FROM contadores WHERE id = ?

<span class="hljs-comment">// Actualizar estado de contador</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; updateEstadoContador(<span class="hljs-built_in">String</span> id, EstadoContador estado)
  → UPDATE contadores SET estado = ? WHERE id = ?
</code></pre>
<h4 id="lecturas">Lecturas</h4>
<pre><code class="language-dart"><span class="hljs-comment">// Insertar nueva lectura</span>
Future&lt;<span class="hljs-built_in">int</span>&gt; insertLectura(Lectura lectura)
  → INSERT INTO lecturas
  → UPDATE estado del contador a <span class="hljs-string">&#x27;registrado&#x27;</span>

<span class="hljs-comment">// Obtener todas las lecturas (ordenadas por fecha DESC)</span>
Future&lt;<span class="hljs-built_in">List</span>&lt;Lectura&gt;&gt; getLecturas()
  → SELECT * FROM lecturas ORDER BY fecha DESC

<span class="hljs-comment">// Verificar si existe lectura HOY para un contador</span>
Future&lt;Lectura?&gt; getLecturaPorContadorHoy(<span class="hljs-built_in">String</span> contadorId)
  → SELECT * FROM lecturas 
    WHERE contador_id = ? 
    ORDER BY fecha DESC LIMIT <span class="hljs-number">1</span>
  → Validación estricta: mismo día/mes/año que hoy

<span class="hljs-comment">// Actualizar lectura existente</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; updateLectura(Lectura lectura)
  → UPDATE lecturas SET ... WHERE id = ?
</code></pre>
<h4 id="utilidades">Utilidades</h4>
<pre><code class="language-dart"><span class="hljs-comment">// Limpiar todas las tablas (solo para desarrollo/testing)</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; deleteAllContadores()
Future&lt;<span class="hljs-keyword">void</span>&gt; deleteAllLecturas()

<span class="hljs-comment">// Resetear el estado de todos los contadores a &#x27;pendiente&#x27;</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; resetEstadoContadores()
  → UPDATE contadores SET estado = <span class="hljs-string">&#x27;pendiente&#x27;</span>
</code></pre>
<hr>
<h2 id="flujo-de-datos">Flujo de Datos</h2>
<h3 id="1-importación-inicial-csv--sqlite">1. Importación Inicial (CSV → SQLite)</h3>
<pre><code>LECTURAS_PILOTO.csv
        ↓
CsvImportService.importInitialData()
        ↓
┌─────────────────────────────────────┐
│ Por cada fila del CSV:              │
│ 1. Parse datos (nombre, vereda)    │
│ 2. Crear Contador con:             │
│    - ultimaLectura = HISTORICO_DIC │
│    - estado = PENDIENTE            │
│ 3. INSERT en tabla 'contadores'    │
│ 4. NO insertar en 'lecturas'       │
└─────────────────────────────────────┘
        ↓
Base de datos lista para Enero
(sin registros en tabla 'lecturas')
</code></pre>
<p><strong>Importante:</strong> Las lecturas históricas del CSV <strong>NO</strong> se insertan en la tabla <code>lecturas</code>. Solo se usan como referencia en <code>ultima_lectura</code> del contador.</p>
<hr>
<h3 id="2-registro-de-nueva-lectura">2. Registro de Nueva Lectura</h3>
<pre><code>Usuario toca contador PENDIENTE
        ↓
RegistroLecturaScreen
        ↓
┌─────────────────────────────────────┐
│ 1. Captura foto (CameraService)    │
│ 2. Obtiene GPS (GpsService)        │
│ 3. Usuario ingresa lectura         │
│ 4. Crea objeto Lectura             │
└─────────────────────────────────────┘
        ↓
DatabaseService.insertLectura()
        ↓
┌─────────────────────────────────────┐
│ TRANSACCIÓN:                        │
│ 1. INSERT INTO lecturas             │
│ 2. UPDATE contadores                │
│    SET estado = 'registrado'        │
└─────────────────────────────────────┘
        ↓
Navegación a ConfirmacionScreen
</code></pre>
<hr>
<h3 id="3-verificación-de-lectura-existente">3. Verificación de Lectura Existente</h3>
<pre><code>Usuario toca contador
        ↓
ListaContadoresScreen._abrirRegistro()
        ↓
DatabaseService.getLecturaPorContadorHoy()
        ↓
┌─────────────────────────────────────┐
│ SELECT * FROM lecturas              │
│ WHERE contador_id = ?               │
│ ORDER BY fecha DESC LIMIT 1         │
└─────────────────────────────────────┘
        ↓
┌─────────────────────────────────────┐
│ Validación estricta de fecha:      │
│ lectura.fecha.year == now.year &amp;&amp;  │
│ lectura.fecha.month == now.month &amp;&amp; │
│ lectura.fecha.day == now.day        │
└─────────────────────────────────────┘
        ↓
Si existe HOY → Mostrar diálogo &quot;Usuario ya registrado&quot;
Si NO existe → Abrir RegistroLecturaScreen
</code></pre>
<hr>
<h3 id="4-exportación-de-datos">4. Exportación de Datos</h3>
<pre><code>Usuario presiona botón EXPORTAR
        ↓
ExportService.exportarLecturas()
        ↓
┌─────────────────────────────────────┐
│ 1. SELECT * FROM lecturas           │
│ 2. SELECT * FROM contadores         │
│ 3. JOIN en memoria (Map lookup)    │
│ 4. Calcular consumo:                │
│    lectura_actual - lectura_anterior│
└─────────────────────────────────────┘
        ↓
Generar CSV con columnas:
- CODIGO_CONCATENADO
- NOMBRE_COMPLETO
- VEREDA
- LECTURA_ANTERIOR
- LECTURA_ACTUAL
- CONSUMO
- FECHA_LECTURA
- HORA_LECTURA
- LATITUD
- LONGITUD
- RUTA_FOTO
        ↓
Guardar en Documents/lecturas_export_YYYYMMDD_HHMM.csv
        ↓
Compartir vía Share API (WhatsApp, Email, etc.)
</code></pre>
<hr>
<h2 id="diagrama-de-flujo---ciclo-de-vida-de-una-lectura">Diagrama de Flujo - Ciclo de Vida de una Lectura</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    INICIO DE MES                            │
│  CSV Import: Contadores en estado PENDIENTE                │
│  Tabla 'lecturas' vacía                                    │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│              USUARIO SELECCIONA CONTADOR                    │
└─────────────────────────────────────────────────────────────┘
                           ↓
                    ¿Tiene lectura HOY?
                    /              \
                 NO /                \ SÍ
                   ↓                  ↓
    ┌──────────────────────┐  ┌──────────────────────┐
    │ Abrir Registro       │  │ Mostrar Diálogo      │
    │ - Cámara             │  │ - Ver detalles       │
    │ - GPS                │  │ - Opción EDITAR      │
    │ - Input lectura      │  └──────────────────────┘
    └──────────────────────┘           │
                ↓                       │ (EDITAR)
    ┌──────────────────────┐           │
    │ GUARDAR LECTURA      │←──────────┘
    │ - INSERT lecturas    │
    │ - UPDATE contador    │
    │   estado='registrado'│
    └──────────────────────┘
                ↓
    ┌──────────────────────┐
    │ Confirmación         │
    │ Volver a lista       │
    └──────────────────────┘
                ↓
┌─────────────────────────────────────────────────────────────┐
│                    FIN DE PERIODO                           │
│  EXPORTAR → CSV con todas las lecturas del mes             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<hr>
<h2 id="consideraciones-de-diseño">Consideraciones de Diseño</h2>
<h3 id="1-desnormalización-intencional">1. Desnormalización Intencional</h3>
<p>La tabla <code>lecturas</code> incluye campos desnormalizados (<code>nombre_usuario</code>, <code>vereda</code>) para:</p>
<ul>
<li><strong>Optimización de reportes</strong>: No requiere JOIN para exportar</li>
<li><strong>Integridad histórica</strong>: Si se modifica el nombre en <code>contadores</code>, las lecturas antiguas mantienen el nombre original</li>
<li><strong>Simplicidad de queries</strong>: Menos complejidad en consultas frecuentes</li>
</ul>
<h3 id="2-validación-de-fecha-estricta">2. Validación de Fecha Estricta</h3>
<p>El método <code>getLecturaPorContadorHoy()</code> valida <strong>día, mes y año</strong> exactos para evitar:</p>
<ul>
<li>Lecturas históricas del CSV (Diciembre 2026) sean consideradas como &quot;de hoy&quot;</li>
<li>Problemas con cambios de mes/año</li>
<li>Confusión entre periodos de facturación</li>
</ul>
<h3 id="3-estado-del-contador">3. Estado del Contador</h3>
<p>El campo <code>estado</code> en <code>contadores</code> es una <strong>caché</strong> del estado de lectura:</p>
<ul>
<li>Se actualiza automáticamente al insertar/actualizar lecturas</li>
<li>Permite filtrado rápido sin JOIN a <code>lecturas</code></li>
<li>Mejora rendimiento en la lista principal</li>
</ul>
<h3 id="4-índices-estratégicos">4. Índices Estratégicos</h3>
<pre><code class="language-sql"><span class="hljs-comment">-- Para consultas &quot;¿Tiene lectura hoy?&quot;</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_lecturas_contador <span class="hljs-keyword">ON</span> lecturas(contador_id);

<span class="hljs-comment">-- Para reportes por periodo</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_lecturas_fecha <span class="hljs-keyword">ON</span> lecturas(fecha);
</code></pre>
<h3 id="5-sincronización-futura">5. Sincronización Futura</h3>
<p>El campo <code>sincronizado</code> en <code>lecturas</code> está preparado para:</p>
<ul>
<li>Sincronización con servidor backend (futuro)</li>
<li>Identificar lecturas pendientes de subir</li>
<li>Evitar duplicados en sincronización</li>
</ul>
<hr>
<h2 id="formato-de-datos">Formato de Datos</h2>
<h3 id="fechas-iso-8601">Fechas (ISO 8601)</h3>
<pre><code>Almacenamiento: &quot;2026-01-19T21:23:42.000&quot;
Display: &quot;19 Ene 2026&quot; / &quot;21:23&quot;
</code></pre>
<h3 id="coordenadas-gps">Coordenadas GPS</h3>
<pre><code>Almacenamiento: REAL (6 decimales)
Ejemplo: latitud = 4.123456, longitud = -73.654321
</code></pre>
<h3 id="rutas-de-fotos">Rutas de Fotos</h3>
<pre><code>Formato: &quot;/data/user/0/com.example.app/app_flutter/photos/IMG_20260119_212342.jpg&quot;
Relativo a: getApplicationDocumentsDirectory()
</code></pre>
<hr>
<h2 id="migración-de-esquema">Migración de Esquema</h2>
<p>Actualmente en <strong>versión 2</strong> del esquema:</p>
<pre><code class="language-dart"><span class="hljs-comment">// database_service.dart</span>
<span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> openDatabase(
  path, 
  version: <span class="hljs-number">2</span>,  <span class="hljs-comment">// ← Versión actual</span>
  onCreate: _createDB,
  onUpgrade: _onUpgrade
);
</code></pre>
<p><strong>Historial de versiones:</strong></p>
<ul>
<li><strong>v1</strong>: Esquema inicial con campos <code>cedula</code> y <code>celular</code></li>
<li><strong>v2</strong>: Eliminados campos <code>cedula</code> y <code>celular</code> (optimización de privacidad)</li>
</ul>
<p>Para futuras migraciones, incrementar <code>version</code> y actualizar <code>_onUpgrade()</code>.</p>
<hr>
<h2 id="ejemplo-de-uso-completo">Ejemplo de Uso Completo</h2>
<pre><code class="language-dart"><span class="hljs-comment">// 1. Importar datos iniciales</span>
<span class="hljs-keyword">final</span> csvService = CsvImportService();
<span class="hljs-keyword">await</span> csvService.importInitialData();

<span class="hljs-comment">// 2. Listar contadores</span>
<span class="hljs-keyword">final</span> dbService = DatabaseService();
<span class="hljs-keyword">final</span> contadores = <span class="hljs-keyword">await</span> dbService.getContadores();

<span class="hljs-comment">// 3. Registrar lectura</span>
<span class="hljs-keyword">final</span> lectura = Lectura(
  contadorId: <span class="hljs-string">&#x27;PUE-102-9&#x27;</span>,
  nombreUsuario: <span class="hljs-string">&#x27;Yenith Pinto&#x27;</span>,
  vereda: <span class="hljs-string">&#x27;Pueblo Nuevo&#x27;</span>,
  lectura: <span class="hljs-number">6350.0</span>,
  fotoPath: <span class="hljs-string">&#x27;/path/to/photo.jpg&#x27;</span>,
  latitud: <span class="hljs-number">4.123456</span>,
  longitud: <span class="hljs-number">-73.654321</span>,
  fecha: <span class="hljs-built_in">DateTime</span>.now(),
  sincronizado: <span class="hljs-keyword">false</span>,
);
<span class="hljs-keyword">await</span> dbService.insertLectura(lectura);

<span class="hljs-comment">// 4. Verificar estado</span>
<span class="hljs-keyword">final</span> lecturaHoy = <span class="hljs-keyword">await</span> dbService.getLecturaPorContadorHoy(<span class="hljs-string">&#x27;PUE-102-9&#x27;</span>);
<span class="hljs-keyword">if</span> (lecturaHoy != <span class="hljs-keyword">null</span>) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Ya registrado hoy: <span class="hljs-subst">${lecturaHoy.lectura}</span>&#x27;</span>);
}

<span class="hljs-comment">// 5. Exportar</span>
<span class="hljs-keyword">final</span> exportService = ExportService();
<span class="hljs-keyword">await</span> exportService.exportarLecturas();
</code></pre>
<hr>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="problema-usuario-ya-registrado-aparece-incorrectamente">Problema: &quot;Usuario ya registrado&quot; aparece incorrectamente</h3>
<p><strong>Causa:</strong> Lecturas históricas del CSV insertadas en tabla <code>lecturas</code></p>
<p><strong>Solución:</strong></p>
<pre><code class="language-dart"><span class="hljs-comment">// En CsvImportService, NO insertar lecturas históricas:</span>
<span class="hljs-comment">// ❌ await _databaseService.insertLectura(lectura);</span>
<span class="hljs-comment">// ✅ Solo usar como referencia en contador.ultimaLectura</span>
</code></pre>
<h3 id="problema-lecturas-no-se-exportan">Problema: Lecturas no se exportan</h3>
<p><strong>Causa:</strong> Tabla <code>lecturas</code> vacía</p>
<p><strong>Verificación:</strong></p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> lecturas;
</code></pre>
<h3 id="problema-estado-no-se-actualiza">Problema: Estado no se actualiza</h3>
<p><strong>Causa:</strong> Falta transacción en <code>insertLectura()</code></p>
<p><strong>Verificación:</strong></p>
<pre><code class="language-dart"><span class="hljs-comment">// Debe incluir ambas operaciones:</span>
<span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">&#x27;lecturas&#x27;</span>, lectura.toMap());
<span class="hljs-keyword">await</span> updateEstadoContador(lectura.contadorId, EstadoContador.registrado);
</code></pre>
<hr>
<p><strong>Última actualización:</strong> 2026-01-19<br>
<strong>Versión del esquema:</strong> 2<br>
<strong>Autor:</strong> Sistema AguaLector</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>